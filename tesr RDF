++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
async function isACBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MB Bank app status:", error.message);
        return false;
    }
}
async function isEIBRunning({ device_id }) {
    try {
        const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking EIB app status:", error.message);
        return false;
    }
}
async function isOCBRunning({ device_id }) {
    try {
        const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking OCB app status:", error.message);
        return false;
    }
}
async function isMBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.mbmobile')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MB Bank app status:", error.message);
        return false;
    }
}
async function isMSBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MSB app status:", error.message);
        return false;
    }
}
async function isNABRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Got an error when checking NAB app status:", error.message);
        return false;
    }
}
async function isTPBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking TPB app status:", error.message);
        return false;
    }
}
async function isVPBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking VPB app status:", error.message);
        return false;
    }
}
module.exports = { isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
    // Click "CLOSE" to close UTILITIES SETTING
    // await client.shell(device_id, 'input tap 540 900');
    await client.shell(device_id, 'input tap 787 1242');
    let running = await isACBRunning( { device_id } );
    if (!running) {
      console.log("ACB Ä‘ang khÃ´ng cháº¡y.");
      return;
    }
    await clearTempFile( { device_id } );
    while (running) {
        const timestamp = Math.floor(Date.now() / 1000).toString();
        const localPath = path.join(targetDir, `${timestamp}.xml`);
        await dumpXmlToLocal( device_id, localPath );
        await checkContentACB( device_id, localPath );
        running = await isACBRunning( { device_id } );
        if (!running) {
          console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile( { device_id } );
          return false;
        }
    }
    return { status: 200, message: 'Success' };
}
async function trackEIB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
    let running = await isEIBRunning( { device_id } );
    if (!running) {
      console.log("EIB Ä‘ang khÃ´ng cháº¡y.");
      return;
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal( device_id, localPath );
      await checkContentEIB( device_id, localPath );
      running = await isEIBRunning( { device_id } );
      if (!running) {
        console.log('ğŸš« Eximbank EDigi Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile( { device_id } );
        return false;
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
    let running = await isOCBRunning( { device_id } );
    if (!running) {
      console.log("OCB Ä‘ang khÃ´ng cháº¡y.");
      return;
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal( device_id, localPath );
      await checkContentOCB( device_id, localPath );
      running = await isOCBRunning( { device_id } );
      if (!running) {
        console.log('ğŸš« OCB OMNI Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile( { device_id } );
        return false;
      }
    }
    return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      console.log("NAB Ä‘ang khÃ´ng cháº¡y");
      return;
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal( device_id, localPath );
      await checkContentNAB( device_id, localPath );
      running = await isNABRunning( { device_id } );
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile( { device_id } );
        return false;
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    console.log("TPB Ä‘ang khÃ´ng cháº¡y");
    return;
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal( device_id, localPath );
    await checkContentTPB( device_id, localPath );
    running = await isTPBRunning( { device_id } );
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile( { device_id } );
      return false;
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    console.log("VPB Ä‘ang khÃ´ng cháº¡y");
    return;
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal( device_id, localPath );
    await checkContentVPB( device_id, localPath );
    running = await isVPBRunning( { device_id } );
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile( { device_id } );
      return false;
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi MB Bank...');
  let running = await isMBRunning( { device_id } );
  if (!running) {
    console.log("MB Ä‘ang khÃ´ng cháº¡y.");
    return;
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal( device_id, localPath );
    await checkContentMB( device_id, localPath );
    running = await isMBRunning( { device_id } );
    if (!running) {
      console.log('ğŸš« MB Bank Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile( { device_id } );
      return false;
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
    ACB: trackACB,
    EIB: trackEIB,
    OCB: trackOCB,
    NAB: trackNAB,
    TPB: trackTPB,
    VPB: trackVPB,
    MB: trackMB,
    // MSB: trackMSB
};
async function mainTracking({ device_id }) {
    const runningBanks = await getRunningBankApps({ device_id });
    const bankName = runningBanks[0];
    const trackFunction = trackFunctions[bankName];
    if (trackFunction) {
        console.log(`ğŸš€ Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
    } else {
        console.log(`âŒ KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
    }
}
async function isACBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MB Bank app status:", error.message);
        return false;
    }
}
async function isEIBRunning({ device_id }) {
    try {
        const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking EIB app status:", error.message);
        return false;
    }
}
async function isOCBRunning({ device_id }) {
    try {
        const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking OCB app status:", error.message);
        return false;
    }
}
async function isNABRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Got an error when checking NAB app status:", error.message);
        return false;
    }
}
async function isTPBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking TPB app status:", error.message);
        return false;
    }
}
async function isVPBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking VPB app status:", error.message);
        return false;
    }
}
async function isMBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof com.mbmobile')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MB Bank app status:", error.message);
        return false;
    }
}
async function isMSBRunning( { device_id } ) {
    try {
        const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
            .then(adb.util.readAll)
            .then(buffer => buffer.toString().trim());
        if (output !== '') return true;
    } catch (error) {
        console.error("Error checking MSB app status:", error.message);
        return false;
    }
}
const bankApps = [
    { name: "ACB", package: "mobile.acb.com.vn" },
    { name: "EIB", package: "com.vnpay.EximBankOmni" },
    { name: "OCB", package: "vn.com.ocb.awe" },
    { name: "NAB", package: "ops.namabank.com.vn" },
    { name: "TPB", package: "com.tpb.mb.gprsandroid" },
    { name: "VPB", package: "com.vnpay.vpbankonline" },
    { name: "MB",  package: "com.mbmobile" },
    { name: "MSB", package: "vn.com.msb.smartBanking" }
];
async function getRunningBankApps({ device_id }) {
    const runningBanks = [];
    try {
      const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
        .then(adb.util.readAll)
        .then(buffer => buffer.toString().trim());
      for (const app of bankApps) {
        if (output.includes(app.package)) {
          console.log(`âœ… ${app.name} Ä‘ang thá»±c sá»± má»Ÿ UI.`);
          runningBanks.push(app.name);
        } else {
          console.log(`âŒ ${app.name} khÃ´ng má»Ÿ UI.`);
        }
      }
    } catch (err) {
      console.error(`âŒ Error checking current foreground app:`, err.message);
    }
    return runningBanks;
}
async function checkRunningBanks({ device_id }) {
    const runningBanks = await getRunningBankApps({
        device_id
    });
    if (runningBanks.length > 1) {
        await closeAll({ device_id });
        console.log("â— VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
        return null;
    }
    return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
    const deviceModel = await deviceHelper.getDeviceModel(device_id);
    await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
    await delay(1000);
    if (deviceModel === "ONEPLUS A5010") {
      // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
      await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
      await delay(500);
      await client.shell(device_id, 'input tap 200 888');
      console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
    }
    else if (deviceModel === "ONEPLUS A5000") {
        // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
        await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
        await delay(500);
        await client.shell(device_id, 'input tap 200 888');
        console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
    }
    else {
      await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
      console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
    }
    return { status: 200, message: 'Success' };
}
module.exports = { checkRunningBanks, mainTracking, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await startTrackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await startTrackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
    ACB: trackACB,
    EIB: trackEIB,
    OCB: trackOCB,
    NAB: trackNAB,
    TPB: trackTPB,
    VPB: trackVPB,
    MB: trackMB,
    // MSB: trackMSB
};
async function startTrackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`ğŸš€ Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`âŒ KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "MSB", package: "vn.com.msb.smartBanking" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\nâœ… ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`âŒ ${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`âŒ Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  if (runningBanks.length > 1) {
    await closeAll({ device_id });
    console.log("â— VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkRunningBanks, startTrackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await startTrackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await startTrackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
    ACB: trackACB,
    EIB: trackEIB,
    OCB: trackOCB,
    NAB: trackNAB,
    TPB: trackTPB,
    VPB: trackVPB,
    MB: trackMB,
    // MSB: trackMSB
};
async function startTrackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`ğŸš€ Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`âŒ KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "MSB", package: "vn.com.msb.smartBanking" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\nâœ… ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`âŒ ${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`âŒ Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  console.log('log runningBanks: ', runningBanks);
  if (runningBanks.length > 1) {
    console.log('log runningBanks 2: ', runningBanks);
    await closeAll({ device_id });
    console.log("â— VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  console.log('log deviceModel:', deviceModel);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    await client.shell(device_id, 'input tap 540 1826');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkRunningBanks, startTrackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await startTrackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await startTrackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
    ACB: trackACB,
    EIB: trackEIB,
    OCB: trackOCB,
    NAB: trackNAB,
    TPB: trackTPB,
    VPB: trackVPB,
    MB: trackMB,
    // MSB: trackMSB
};
async function startTrackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`ğŸš€ Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`âŒ KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "MSB", package: "vn.com.msb.smartBanking" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\nâœ… ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`âŒ ${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`âŒ Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  console.log('log runningBanks: ', runningBanks);
  if (runningBanks.length > 1) {
    console.log('log runningBanks 2: ', runningBanks);
    await closeAll({ device_id });
    console.log("â— VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  console.log('log deviceModel:', deviceModel);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1868');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkRunningBanks, startTrackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'ops.namabank.com.vn') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await startTrackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await startTrackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
    ACB: trackACB,
    EIB: trackEIB,
    OCB: trackOCB,
    NAB: trackNAB,
    TPB: trackTPB,
    VPB: trackVPB,
    MB: trackMB,
    // MSB: trackMSB
};
async function startTrackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`ğŸš€ Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`âŒ KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "MSB", package: "vn.com.msb.smartBanking" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\nâœ… ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`âŒ ${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`âŒ Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  if (runningBanks.length > 1) {
    await closeAll({ device_id });
    console.log("â— VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  console.log('log deviceModel:', deviceModel);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1868');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkRunningBanks, startTrackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const coordinatessSemiAuto = require('../config/coordinatessSemiAuto.json');
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isACBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'mobile.acb.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackNCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« NCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isNCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentNCB(device_id, localPath);
    running = await isNCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isNCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« NCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.ncb.bank') {
      console.log(`ğŸš« NCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« NCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await startTrackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await startTrackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.vpbankonline') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSHBSAHA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SHB SAHA Ä‘ang Ä‘á»£i chá»‹ Hira nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSHBSAHARunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSHBSAHARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSHBSAHARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SHB SAHA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'shb.saha.mbanking') {
      console.log(`ğŸš« SHB SAHA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SHB SAHA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackBIDV({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« BIDV khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isBIDVRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentBIDV(device_id, localPath);
    running = await isBIDVRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isBIDVRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« BIDV process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.bidv') {
      console.log(`ğŸš« BIDV khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« BIDV Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVCB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« VCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isVCBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentVCB(device_id, localPath);
    running = await isVCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.VCB') {
      console.log(`ğŸš« VCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSEA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SEA khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSEARunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSEARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSEARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SEA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.seabank.mb1') {
      console.log(`ğŸš« SEA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SEA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackICB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« Vietin khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isICBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isICBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isICBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ICB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vietinbank.ipay') {
      console.log(`ğŸš« ICB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ICB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackPVC({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« PVC khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isPVCRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isPVCRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isPVCRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« PVC process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.pvcombank.retail') {
      console.log(`ğŸš« PVC khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« PVC Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackLPB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« LPB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isLPBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isLPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isLPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« LPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.lpb.lienviet24h') {
      console.log(`ğŸš« LPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« LPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackABB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« ABB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isABBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isABBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isABBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ABB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.abbank') {
      console.log(`ğŸš« ABB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ABB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMSB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« MSB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isMSBRunning( { device_id } );
  if (!running) {
    return await startTrackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isMSBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMSBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MSB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await startTrackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.msb.mobileBanking.corp') {
      console.log(`ğŸš« MSB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MSB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await startTrackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
  ACB: trackACB,
  EIB: trackEIB,
  OCB: trackOCB,
  NCB: trackNCB,
  NAB: trackNAB,
  TPB: trackTPB,
  VPB: trackVPB,
  MB: trackMB,
  SHBSAHA: trackSHBSAHA,
  BIDV: trackBIDV,
  VCB: trackVCB,
  SEA: trackSEA,
  ICB: trackICB,
  PVC: trackPVC,
  LPB: trackLPB,
  ABB: trackABB,
  MSB: trackMSB
};
async function startTrackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function checkDeviceSemiAuto({ device_id }) {
  try {
    const deviceModel = await deviceHelper.getDeviceModel(device_id);
    const deviceCoordinates = coordinatessSemiAuto[deviceModel];
    if (deviceCoordinates == undefined) {
      return { status: 500, valid: false, message: 'KhÃ´ng thá»ƒ xuáº¥t bÃ¡n tá»± Ä‘á»™ng' };
    }
    return deviceCoordinates;
  } catch (error) {
    console.error(`Error checking device: ${error.message}`);
    throw error;
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ACB app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.ncb.bank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking NCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isBIDVRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.bidv')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking BIDV app status:", error.message);
    return false;
  }
}
async function isVCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.VCB')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VCB app status:", error.message);
    return false;
  }
}
async function isSEARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.seabank.mb1')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SEA app status:", error.message);
    return false;
  }
}
async function isSHBSAHARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof shb.saha.mbanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SHB SAHA status:", error.message);
    return false;
  }
}
async function isICBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vietinbank.ipay')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ICB app status:", error.message);
    return false;
  }
}
async function isPVCRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.pvcombank.retail')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking PVC app status:", error.message);
    return false;
  }
}
async function isLPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.lpb.lienviet24h')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking LPB app status:", error.message);
    return false;
  }
}
async function isABBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.abbank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ABB app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking.corp')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NCB", package: "com.ncb.bank" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "SHBSAHA", package: "vn.shb.saha.mbanking" },
  { name: "BIDV", package: "com.vnpay.bidv" },
  { name: "VCB", package: "com.VCB" },
  { name: "SEA", package: "vn.com.seabank.mb1" },
  { name: "ICB", package: "com.vietinbank.ipay" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\n ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  if (runningBanks.length > 1) {
    await closeAll({ device_id });
    console.log("VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010" || deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1868');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-G781") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1886');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkDeviceSemiAuto, checkRunningBanks, startTrackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const coordinatessSemiAuto = require('../config/coordinatessSemiAuto.json');
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isACBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'mobile.acb.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackNCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« NCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isNCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentNCB(device_id, localPath);
    running = await isNCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isNCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« NCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.ncb.bank') {
      console.log(`ğŸš« NCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« NCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await trackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await trackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.vpbankonline') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSHBSAHA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SHB SAHA Ä‘ang Ä‘á»£i chá»‹ Hira nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSHBSAHARunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSHBSAHARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSHBSAHARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SHB SAHA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'shb.saha.mbanking') {
      console.log(`ğŸš« SHB SAHA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SHB SAHA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackBIDV({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« BIDV khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isBIDVRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentBIDV(device_id, localPath);
    running = await isBIDVRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isBIDVRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« BIDV process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.bidv') {
      console.log(`ğŸš« BIDV khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« BIDV Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVCB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« VCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isVCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentVCB(device_id, localPath);
    running = await isVCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.VCB') {
      console.log(`ğŸš« VCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSEA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SEA khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSEARunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSEARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSEARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SEA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.seabank.mb1') {
      console.log(`ğŸš« SEA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SEA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackICB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« Vietin khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isICBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isICBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isICBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ICB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vietinbank.ipay') {
      console.log(`ğŸš« ICB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ICB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackPVC({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« PVC khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isPVCRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isPVCRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isPVCRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« PVC process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.pvcombank.retail') {
      console.log(`ğŸš« PVC khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« PVC Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackLPB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« LPB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isLPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isLPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isLPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« LPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.lpb.lienviet24h') {
      console.log(`ğŸš« LPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« LPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackABB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« ABB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isABBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isABBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isABBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ABB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.abbank') {
      console.log(`ğŸš« ABB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ABB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMSB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« MSB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isMSBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isMSBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMSBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MSB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.msb.mobileBanking.corp') {
      console.log(`ğŸš« MSB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MSB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
  ACB: trackACB,
  EIB: trackEIB,
  OCB: trackOCB,
  NCB: trackNCB,
  NAB: trackNAB,
  TPB: trackTPB,
  VPB: trackVPB,
  MB: trackMB,
  SHBSAHA: trackSHBSAHA,
  BIDV: trackBIDV,
  VCB: trackVCB,
  SEA: trackSEA,
  ICB: trackICB,
  PVC: trackPVC,
  LPB: trackLPB,
  ABB: trackABB,
  MSB: trackMSB
};
async function trackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function checkDeviceSemiAuto({ device_id }) {
  try {
    const deviceModel = await deviceHelper.getDeviceModel(device_id);
    const deviceCoordinates = coordinatessSemiAuto[deviceModel];
    if (deviceCoordinates == undefined) {
      return { status: 500, valid: false, message: 'KhÃ´ng thá»ƒ xuáº¥t bÃ¡n tá»± Ä‘á»™ng' };
    }
    return deviceCoordinates;
  } catch (error) {
    console.error(`Error checking device: ${error.message}`);
    throw error;
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ACB app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.ncb.bank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking NCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isBIDVRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.bidv')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking BIDV app status:", error.message);
    return false;
  }
}
async function isVCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.VCB')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VCB app status:", error.message);
    return false;
  }
}
async function isSEARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.seabank.mb1')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SEA app status:", error.message);
    return false;
  }
}
async function isSHBSAHARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof shb.saha.mbanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SHB SAHA status:", error.message);
    return false;
  }
}
async function isICBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vietinbank.ipay')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ICB app status:", error.message);
    return false;
  }
}
async function isPVCRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.pvcombank.retail')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking PVC app status:", error.message);
    return false;
  }
}
async function isLPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.lpb.lienviet24h')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking LPB app status:", error.message);
    return false;
  }
}
async function isABBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.abbank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ABB app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking.corp')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NCB", package: "com.ncb.bank" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "SHBSAHA", package: "vn.shb.saha.mbanking" },
  { name: "BIDV", package: "com.vnpay.bidv" },
  { name: "VCB", package: "com.VCB" },
  { name: "SEA", package: "vn.com.seabank.mb1" },
  { name: "ICB", package: "com.vietinbank.ipay" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\n ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  if (runningBanks.length > 1) {
    await closeAll({ device_id });
    console.log("VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010" || deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1868');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-G781") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1886');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkDeviceSemiAuto, checkRunningBanks, trackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };++ b/functions/bankStatus.function.js
require('dotenv').config();
const adb = require('adbkit');
const path = require('path');
const adbPath = path.join(__dirname, '../platform-tools', 'adb.exe');
const client = adb.createClient({ bin: adbPath });
const deviceHelper = require('../helpers/deviceHelper');
const { delay } = require('../helpers/functionHelper');
const fs = require('fs');
const ensureDirectoryExists = ( dirPath ) => {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
};
const coordinatessSemiAuto = require('../config/coordinatessSemiAuto.json');
const { checkContentACB, checkContentEIB, checkContentOCB, checkContentNAB, checkContentTPB, checkContentVPB, checkContentMB } = require('../functions/checkBank.function');
async function clearTempFile( { device_id } ) {
  try {
    await client.shell(device_id, `rm /sdcard/temp_dump.xml`);
    await delay(1000);
  } catch (error) {
    console.error("Cannot delete file temp_dump.xml:", error.message);
  }
}
async function dumpXmlToLocal ( device_id, localPath ) {
  try {
    const tempPath = `/sdcard/temp_dump.xml`;
    await client.shell(device_id, `uiautomator dump ${tempPath}`);
    await client.pull( device_id , tempPath)
      .then(stream => new Promise((resolve, reject) => {
        const fileStream = fs.createWriteStream(localPath);
        stream.pipe(fileStream);
        fileStream.on('finish', resolve);
        fileStream.on('error', reject);
    }));
  } catch (error) {
      console.error(`Error occurred while dumping XML to local. ${error.message}`);
  }
}
async function trackACB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi ACB...');
  // Click "CLOSE" to close UTILITIES SETTING
  // await client.shell(device_id, 'input tap 540 900');
  await client.shell(device_id, 'input tap 787 1242');
  let running = await isACBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentACB(device_id, localPath);
    running = await isACBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isACBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ACB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'mobile.acb.com.vn') {
      console.log(`ğŸš« ACB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ACB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function getCurrentForegroundApp({ device_id }) {
  try {
    const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    const match = output.match(/u0\s+([^\s\/]+)\//);
    if (match && match[1]) {
      return match[1];
    }
    return null;
  } catch (error) {
    console.error("Error getting current foreground app:", error.message);
    return null;
  }
}
async function trackEIB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi EIB...');
  let running = await isEIBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentEIB(device_id, localPath);
    running = await isEIBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isEIBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« EIB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.EximBankOmni') {
      console.log(`ğŸš« EIB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« EIB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackOCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi OCB...');
  let running = await isOCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentOCB(device_id, localPath);
    running = await isOCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isOCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« OCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.ocb.awe') {
      console.log(`ğŸš« OCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« OCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackNCB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« NCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isNCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentNCB(device_id, localPath);
    running = await isNCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isNCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« NCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.ncb.bank') {
      console.log(`ğŸš« NCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« NCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
 async function trackNAB ( { device_id } ) {
    const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
    ensureDirectoryExists(targetDir);
    console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi NAB...');
    let running = await isNABRunning( { device_id } );
    if (!running) {
      return await trackingLoop({ device_id });
    }
    await clearTempFile( { device_id } );
    while (running) {
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const localPath = path.join(targetDir, `${timestamp}.xml`);
      await dumpXmlToLocal(device_id, localPath);
      await checkContentNAB(device_id, localPath);
      running = await isNABRunning({ device_id });
      const currentApp = await getCurrentForegroundApp({ device_id });
      if (currentApp === null) {
        // Náº¿u isNABRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
        if (!running) {
          console.log('ğŸš« NAB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
          await clearTempFile({ device_id });
          return await trackingLoop({ device_id });
        }
        // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
      } else if (currentApp !== 'ops.namabank.com.vn') {
        console.log(`ğŸš« NAB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      if (!running) {
        console.log('ğŸš« NAB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
    }
    return { status: 200, message: 'Success' };
}
async function trackTPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi TPB...');
  let running = await isTPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentTPB(device_id, localPath);
    running = await isTPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isTPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« TPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.tpb.mb.gprsandroid') {
      console.log(`ğŸš« TPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« TPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVPB ( { device_id } ) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Báº¯t Ä‘áº§u theo dÃµi VPB...');
  let running = await isVPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentVPB(device_id, localPath);
    running = await isVPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.vpbankonline') {
      console.log(`ğŸš« VPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸ” Äang theo dÃµi MB Bank...');
  let running = await isMBRunning({ device_id });
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile({ device_id });
  while (running) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const localPath = path.join(targetDir, `${timestamp}.xml`);
    await dumpXmlToLocal(device_id, localPath);
    await checkContentMB(device_id, localPath);
    running = await isMBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.mbmobile') {
      console.log(`ğŸš« MB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSHBSAHA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SHB SAHA Ä‘ang Ä‘á»£i chá»‹ Hira nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSHBSAHARunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSHBSAHARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSHBSAHARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SHB SAHA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'shb.saha.mbanking') {
      console.log(`ğŸš« SHB SAHA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SHB SAHA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackBIDV({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« BIDV khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isBIDVRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentBIDV(device_id, localPath);
    running = await isBIDVRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isBIDVRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« BIDV process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.bidv') {
      console.log(`ğŸš« BIDV khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« BIDV Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackVCB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« VCB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isVCBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    // const timestamp = Math.floor(Date.now() / 1000).toString();
    // const localPath = path.join(targetDir, `${timestamp}.xml`);
    // await dumpXmlToLocal(device_id, localPath);
    // await checkContentVCB(device_id, localPath);
    running = await isVCBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isVCBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« VCB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.VCB') {
      console.log(`ğŸš« VCB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« VCB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackSEA({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« SEA khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isSEARunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isSEARunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isSEARunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« SEA process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.seabank.mb1') {
      console.log(`ğŸš« SEA khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« SEA Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackICB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« Vietin khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isICBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isICBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isICBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ICB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vietinbank.ipay') {
      console.log(`ğŸš« ICB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ICB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackPVC({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« PVC khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isPVCRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isPVCRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isPVCRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« PVC process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.pvcombank.retail') {
      console.log(`ğŸš« PVC khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« PVC Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackLPB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« LPB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isLPBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isLPBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isLPBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« LPB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.lpb.lienviet24h') {
      console.log(`ğŸš« LPB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« LPB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackABB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« ABB khÃ´ng cÃ³ thiáº¿t bá»‹ Ä‘á»ƒ nghiÃªn cá»©u nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isABBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isABBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isABBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« ABB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'com.vnpay.abbank') {
      console.log(`ğŸš« ABB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« ABB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
async function trackMSB({ device_id }) {
  const targetDir = path.join('C:\\att_mobile_client_newsh\\logs\\');
  ensureDirectoryExists(targetDir);
  console.log('ğŸš« MSB khÃ´ng cho phÃ©p dump mÃ n hÃ¬nh nÃªn khÃ´ng há»— trá»£ theo dÃµi...');
  let running = await isMSBRunning( { device_id } );
  if (!running) {
    return await trackingLoop({ device_id });
  }
  await clearTempFile( { device_id } );
  while (running) {
    running = await isMSBRunning({ device_id });
    const currentApp = await getCurrentForegroundApp({ device_id });
    if (currentApp === null) {
      // Náº¿u isMSBRunning váº«n true, tiáº¿p tá»¥c theo dÃµi
      if (!running) {
        console.log('ğŸš« MSB process Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
        await clearTempFile({ device_id });
        return await trackingLoop({ device_id });
      }
      // Náº¿u váº«n cháº¡y, tiáº¿p tá»¥c bÃ¬nh thÆ°á»ng
    } else if (currentApp !== 'vn.com.msb.mobileBanking.corp') {
      console.log(`ğŸš« MSB khÃ´ng cÃ²n má»Ÿ UI. Äang má»Ÿ: ${currentApp}. Dá»«ng theo dÃµi.`);
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
    if (!running) {
      console.log('ğŸš« MSB Ä‘Ã£ táº¯t. Dá»«ng theo dÃµi.');
      await clearTempFile({ device_id });
      return await trackingLoop({ device_id });
    }
  }
  return { status: 200, message: 'Success' };
}
const trackFunctions = {
  ACB: trackACB,
  EIB: trackEIB,
  OCB: trackOCB,
  NCB: trackNCB,
  NAB: trackNAB,
  TPB: trackTPB,
  VPB: trackVPB,
  MB: trackMB,
  SHBSAHA: trackSHBSAHA,
  BIDV: trackBIDV,
  VCB: trackVCB,
  SEA: trackSEA,
  ICB: trackICB,
  PVC: trackPVC,
  LPB: trackLPB,
  ABB: trackABB,
  MSB: trackMSB
};
async function trackingLoop({ device_id }) {
  while (true) {
    const bankName = await checkRunningBanks({ device_id });
    if (bankName) {
      const trackFunction = trackFunctions[bankName];
      if (trackFunction) {
        console.log(`Báº¯t Ä‘áº§u theo dÃµi ${bankName}...`);
        await trackFunction({ device_id });
      }
      // else {
      //   console.log(`KhÃ´ng tÃ¬m tháº¥y hÃ m track cho bank ${bankName}`);
      // }
      break; // break loop náº¿u theo dÃµi Ä‘Æ°á»£c app há»£p lá»‡
    } else {
      console.log('â³ Äang chá» user má»Ÿ Ä‘Ãºng 1 app ngÃ¢n hÃ ng...');
      await delay(3000); // Ä‘á»£i 3s rá»“i check láº¡i
    }
  }
}
async function checkDeviceSemiAuto({ device_id }) {
  try {
    const deviceModel = await deviceHelper.getDeviceModel(device_id);
    const deviceCoordinates = coordinatessSemiAuto[deviceModel];
    if (deviceCoordinates == undefined) {
      return { status: 500, valid: false, message: 'KhÃ´ng thá»ƒ xuáº¥t bÃ¡n tá»± Ä‘á»™ng' };
    }
    return deviceCoordinates;
  } catch (error) {
    console.error(`Error checking device: ${error.message}`);
    throw error;
  }
}
async function isACBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof mobile.acb.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ACB app status:", error.message);
    return false;
  }
}
async function isEIBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.EximBankOmni')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking EIB app status:", error.message);
    return false;
  }
}
async function isOCBRunning({ device_id }) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.ocb.awe')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking OCB app status:", error.message);
    return false;
  }
}
async function isNCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.ncb.bank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Error checking NCB app status:", error.message);
    return false;
  }
}
async function isNABRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof ops.namabank.com.vn')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
      if (output !== '') return true;
  } catch (error) {
    console.error("Got an error when checking NAB app status:", error.message);
    return false;
  }
}
async function isTPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.tpb.mb.gprsandroid')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking TPB app status:", error.message);
    return false;
  }
}
async function isVPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.vpbankonline')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VPB app status:", error.message);
    return false;
  }
}
async function isMBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.mbmobile')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MB Bank app status:", error.message);
    return false;
  }
}
async function isBIDVRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.bidv')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking BIDV app status:", error.message);
    return false;
  }
}
async function isVCBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.VCB')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking VCB app status:", error.message);
    return false;
  }
}
async function isSEARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.seabank.mb1')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SEA app status:", error.message);
    return false;
  }
}
async function isSHBSAHARunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof shb.saha.mbanking')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking SHB SAHA status:", error.message);
    return false;
  }
}
async function isICBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vietinbank.ipay')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ICB app status:", error.message);
    return false;
  }
}
async function isPVCRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.pvcombank.retail')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking PVC app status:", error.message);
    return false;
  }
}
async function isLPBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.lpb.lienviet24h')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking LPB app status:", error.message);
    return false;
  }
}
async function isABBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof com.vnpay.abbank')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking ABB app status:", error.message);
    return false;
  }
}
async function isMSBRunning( { device_id } ) {
  try {
    const output = await client.shell(device_id, 'pidof vn.com.msb.smartBanking.corp')
      .then(adb.util.readAll)
      .then(buffer => buffer.toString().trim());
    if (output !== '') return true;
  } catch (error) {
    console.error("Error checking MSB app status:", error.message);
    return false;
  }
}
const bankApps = [
  { name: "ACB", package: "mobile.acb.com.vn" },
  { name: "EIB", package: "com.vnpay.EximBankOmni" },
  { name: "OCB", package: "vn.com.ocb.awe" },
  { name: "NCB", package: "com.ncb.bank" },
  { name: "NAB", package: "ops.namabank.com.vn" },
  { name: "TPB", package: "com.tpb.mb.gprsandroid" },
  { name: "VPB", package: "com.vnpay.vpbankonline" },
  { name: "MB",  package: "com.mbmobile" },
  { name: "SHBSAHA", package: "vn.shb.saha.mbanking" },
  { name: "BIDV", package: "com.vnpay.bidv" },
  { name: "VCB", package: "com.VCB" },
  { name: "SEA", package: "vn.com.seabank.mb1" },
  { name: "ICB", package: "com.vietinbank.ipay" }
];
async function getRunningBankApps({ device_id }) {
  const runningBanks = [];
  try {
    // const output = await client.shell(device_id, `dumpsys activity activities | grep mResumedActivity`)
    const output = await client.shell(device_id, `dumpsys activity activities`)
      .then(adb.util.readAll)
      // .then(buffer => buffer.toString().trim());
      .then(buffer => buffer.toString());
    for (const app of bankApps) {
      if (output.includes(app.package)) {
        console.log(`\n ${app.name} Ä‘ang má»Ÿ trong activity stack.`);
        runningBanks.push(app.name);
      }
      // else {
      //   console.log(`${app.name} khÃ´ng cÃ³ trong activity stack.`);
      // }
    }
  } catch (err) {
    console.error(`Error checking current foreground app:`, err.message);
  }
  return runningBanks;
}
async function checkRunningBanks({ device_id }) {
  const runningBanks = await getRunningBankApps({ device_id });
  if (runningBanks.length > 1) {
    await closeAll({ device_id });
    console.log("VUI LÃ’NG THá»°C HIá»†N Láº I (CHá»ˆ 1 BANK)");
    return null;
  }
  else {
    console.log('Äang báº¯t Ä‘áº§u theo dÃµi xem cÃ³ Ä‘Æ¡n khÃ´ng, náº¿u cÃ³ thÃ¬ ');
  }
  return runningBanks[0] || null;
}
async function closeAll ({ device_id }) {
  const deviceModel = await deviceHelper.getDeviceModel(device_id);
  await client.shell(device_id, 'input keyevent KEYCODE_APP_SWITCH');
  await delay(1000);
  if (deviceModel === "ONEPLUS A5010") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "ONEPLUS A5000") {
    // await client.shell(device_id, 'input swipe 540 1414 540 150 100'); // input swipe <x1> <y1> <x2> <y2> <duration>
    await client.shell(device_id, 'input swipe 540 1080 2182 1080 100');
    await delay(500);
    await client.shell(device_id, 'input tap 200 888');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-A155") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1868');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else if (deviceModel === "SM-G781") {
    // await client.shell(device_id, 'input tap 540 1826');
    await client.shell(device_id, 'input tap 540 1886');
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  else {
    await client.shell(device_id, 'input tap 540 1750'); // Click "Close all", for example: Note9
    console.log('ÄÃ£ Ä‘Ã³ng táº¥t cáº£ cÃ¡c app Ä‘ang má»Ÿ');
  }
  return { status: 200, message: 'Success' };
}
module.exports = { checkDeviceSemiAuto, checkRunningBanks, trackingLoop, isACBRunning, isEIBRunning, isOCBRunning, isNABRunning, isTPBRunning, isVPBRunning, isMBRunning, isMSBRunning };
